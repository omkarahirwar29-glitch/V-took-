<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InfernoX Chat Multi-Page SPA</title>
  <style>
    :root{--green:#34a853;--blue:#4285f4;--muted:#666}
    body{font-family:Inter, Poppins, system-ui; margin:0; background:#f5f7fb; color:#111}
    .topbar{background:var(--green); color:#fff; padding:10px 16px; display:flex; align-items:center; justify-content:space-between}
    .brand{font-weight:700}
    .container{max-width:1100px;margin:18px auto;padding:12px}
    .row{display:flex;gap:12px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 8px 20px rgba(12,18,30,0.06)}
    button{background:var(--blue);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    input, textarea{padding:8px;border-radius:8px;border:1px solid #e6eef6}
    .hidden{display:none}
    .users-list{display:flex;flex-direction:column;gap:8px;max-height:66vh;overflow:auto;margin-top:8px}
    .user-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .user-item:hover{background:#f0f6f3}
    .avatar{width:44px;height:44px;border-radius:50%;background:#ddd;display:flex;align-items:center;justify-content:center;font-weight:700}
    .app-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .app-card{background:#fff;padding:12px;border-radius:10px;text-align:center}
    .messages{display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:60vh;padding:8px}
    .msg{max-width:70%;padding:8px;border-radius:10px}
    .msg.me{background:var(--green);color:#fff;align-self:flex-end}
    .msg.other{background:#eee;align-self:flex-start}
    .small{font-size:13px;color:var(--muted)}
    .nav {display:flex; gap:8px;}
    .profile-preview img{width:80px;height:80px;border-radius:12px;object-fit:cover}
    .call-video{width:100%;height:180px;background:#000}
    footer{padding:12px;text-align:center;color:#666}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">InfernoX ‚Äî Chat & Store</div>
    <div style="display:flex;align-items:center;gap:12px">
      <div id="topUser" style="display:flex;align-items:center;gap:8px">
        <div class="avatar" id="topAvatar">U</div>
        <div id="topName" style="font-weight:600"></div>
      </div>
      <div class="nav">
        <button onclick="navTo('#/users')">Users</button>
        <button onclick="navTo('#/profile')">Profile</button>
        <button onclick="navTo('#/calls')">Calls</button>
        <button id="signOutBtn" class="hidden">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- LOGIN -->
    <div id="loginCard" class="card" style="text-align:center;">
      <h2>Login with Google</h2>
      <p class="small">Use your Google account. Make sure Google sign-in enabled in Firebase console.</p>
      <button id="googleLoginBtn">üîê Sign in with Google</button>
    </div>

    <!-- USERS PAGE -->
    <div id="usersPage" class="hidden">
      <div class="row">
        <div style="width:360px">
          <div class="card">
            <div style="display:flex;align-items:center;gap:10px">
              <div class="avatar" id="myAvatar">U</div>
              <div>
                <div id="myName" style="font-weight:700">User</div>
                <div id="myMail" class="small"></div>
              </div>
            </div>

            <hr/>
            <div>
              <input id="searchBox" placeholder="Search users by username or name" style="width:100%" />
            </div>

            <div class="users-list card" id="usersList"></div>
          </div>
        </div>

        <div style="flex:1">
          <div class="card">
            <h3>Instructions</h3>
            <p class="small">Click any user to open chat page. Use top nav to go to profile and calls. Profile lets you set username & upload image.</p>
            <hr/>
            <h4>Recent chats</h4>
            <div id="recentContainer" class="users-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHAT PAGE -->
    <div id="chatPage" class="hidden">
      <div class="row">
        <div style="flex:1" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700" id="chatTitle">Chat</div>
              <div class="small" id="chatSubtitle"></div>
            </div>
            <div>
              <button id="callAudioBtn">Audio</button>
              <button id="callVideoBtn">Video</button>
              <button onclick="navTo('#/users')">Back</button>
            </div>
          </div>

          <div id="messages" class="messages" style="margin-top:8px"></div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <input id="messageInput" placeholder="Type a message" style="flex:1" />
            <input type="file" id="filePicker" />
            <button id="sendMsgBtn">Send</button>
          </div>
        </div>

        <div style="width:320px" class="card">
          <h4>Conversation Info</h4>
          <div id="convInfo" class="small"></div>
          <hr/>
          <div id="convFiles"></div>
        </div>
      </div>
    </div>

    <!-- PROFILE PAGE -->
    <div id="profilePage" class="hidden">
      <div class="card">
        <h3>My Profile</h3>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="profile-preview">
            <img id="profileImg" src="" alt="profile" style="width:120px;height:120px;border-radius:12px;object-fit:cover"/>
          </div>
          <div style="flex:1">
            <div><strong id="profileNameDisplay">Name</strong></div>
            <div class="small" id="profileEmail"></div>

            <div style="margin-top:12px">
              <input id="usernameSet" placeholder="Set username (unique)" />
              <div style="margin-top:8px"><input type="file" id="profilePicInput" /></div>
              <div style="margin-top:8px;">
                <button id="saveProfileBtn">Save Profile</button>
                <button onclick="navTo('#/users')">Back</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CALLS PAGE -->
    <div id="callsPage" class="hidden">
      <div class="row">
        <div style="flex:1" class="card">
          <h3>Calls (demo signaling)</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="callTarget" placeholder="Enter friend's UID to call" style="flex:1"/>
            <button id="startVideoCallBtn">Start Video</button>
            <button id="startAudioCallBtn">Start Audio</button>
          </div>
          <hr/>
          <div>
            <video id="localVid" class="call-video" autoplay muted playsinline></video>
            <video id="remoteVid" class="call-video" autoplay playsinline style="margin-top:8px"></video>
            <div style="margin-top:8px"><button id="hangupBtn" class="hidden">Hangup</button></div>
          </div>
        </div>

        <div style="width:320px" class="card">
          <h4>Incoming calls</h4>
          <div id="incomingCalls" class="users-list"></div>
        </div>
      </div>
    </div>

  </div>

  <footer>Built with Firebase ‚Äî Make sure to host on HTTPS (Firebase Hosting recommended)</footer>

  <!-- Firebase + App Script -->
  <script type="module">
  // ----------------------------
  // Firebase imports (modular v10)
  // ----------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, collection, addDoc,
    onSnapshot, query, where, orderBy, serverTimestamp, getDocs
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

  // ---------- your firebase config (you provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBtYFjOBAuDQkcrwKRKP4FzbSb5N5pudYk",
    authDomain: "v-tok-d78ad.firebaseapp.com",
    projectId: "v-tok-d78ad",
    storageBucket: "v-tok-d78ad.firebasestorage.app",
    messagingSenderId: "448669303511",
    appId: "1:448669303511:web:7af9fec0b6e0f981eaa692",
    measurementId: "G-ZJ2L4E58T1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ---------- UI refs ----------
  const loginCard = document.getElementById('loginCard');
  const googleLoginBtn = document.getElementById('googleLoginBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const topAvatar = document.getElementById('topAvatar');
  const topName = document.getElementById('topName');

  const usersPage = document.getElementById('usersPage');
  const usersList = document.getElementById('usersList');
  const searchBox = document.getElementById('searchBox');
  const myAvatar = document.getElementById('myAvatar');
  const myName = document.getElementById('myName');
  const myMail = document.getElementById('myMail');
  const recentContainer = document.getElementById('recentContainer');

  const chatPage = document.getElementById('chatPage');
  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendMsgBtn = document.getElementById('sendMsgBtn');
  const filePicker = document.getElementById('filePicker');
  const chatTitle = document.getElementById('chatTitle');
  const chatSubtitle = document.getElementById('chatSubtitle');
  const convInfo = document.getElementById('convInfo');
  const convFiles = document.getElementById('convFiles');

  const profilePage = document.getElementById('profilePage');
  const profileImg = document.getElementById('profileImg');
  const profileNameDisplay = document.getElementById('profileNameDisplay');
  const profileEmail = document.getElementById('profileEmail');
  const usernameSet = document.getElementById('usernameSet');
  const profilePicInput = document.getElementById('profilePicInput');
  const saveProfileBtn = document.getElementById('saveProfileBtn');

  const callsPage = document.getElementById('callsPage');
  const callTarget = document.getElementById('callTarget');
  const startVideoCallBtn = document.getElementById('startVideoCallBtn');
  const startAudioCallBtn = document.getElementById('startAudioCallBtn');
  const localVid = document.getElementById('localVid');
  const remoteVid = document.getElementById('remoteVid');
  const hangupBtn = document.getElementById('hangupBtn');
  const incomingCalls = document.getElementById('incomingCalls');

  // state
  let currentUser = null;
  let currentChatId = null;
  let currentPeer = null;
  let unsubMessages = null;
  let unsubUsers = null;
  let unsubRecent = null;

  // Hash routing
  function navTo(route){
    location.hash = route;
  }
  function showPage(id){
    // hide all
    [usersPage, chatPage, profilePage, callsPage].forEach(p => p.classList.add('hidden'));
    if (id) document.getElementById(id).classList.remove('hidden');
  }
  function handleRoute(){
    const h = location.hash || '#/users';
    if (h.startsWith('#/chat/')) {
      const uid = h.split('/')[2];
      openChat(uid);
      showPage('chatPage');
    } else if (h === '#/profile') {
      showProfile();
      showPage('profilePage');
    } else if (h === '#/calls') {
      showCalls();
      showPage('callsPage');
    } else {
      showUsers();
      showPage('usersPage');
    }
  }
  window.addEventListener('hashchange', handleRoute);

  // Auth
  googleLoginBtn.onclick = async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (e) { alert('Login failed: '+e.message) }
  };
  signOutBtn.onclick = async () => { await signOut(auth); location.reload(); };

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (user) {
      loginCard.classList.add('hidden');
      signOutBtn.classList.remove('hidden');
      topAvatar.textContent = (user.displayName||'U')[0].toUpperCase();
      topName.textContent = user.displayName || user.email;
      myAvatar.textContent = (user.displayName||'U')[0].toUpperCase();
      myName.textContent = user.displayName || 'Unnamed';
      myMail.textContent = user.email || '';
      profileNameDisplay.textContent = user.displayName || 'Unnamed';
      profileEmail.textContent = user.email || '';

      // ensure user doc exists
      const uRef = doc(db, 'users', user.uid);
      const snap = await getDoc(uRef);
      if (!snap.exists()) {
        await setDoc(uRef, {
          displayName: user.displayName || null,
          email: user.email || null,
          username: null,
          photoURL: user.photoURL || null,
          createdAt: serverTimestamp()
        });
      } else {
        const data = snap.data();
        if (data.photoURL) profileImg.src = data.photoURL;
        if (data.username) usernameSet.value = data.username;
      }

      // start listeners
      startUsersListener();
      startRecentListener();
      handleRoute();
    } else {
      loginCard.classList.remove('hidden');
      signOutBtn.classList.add('hidden');
      navTo('#/users');
    }
  });

  // Users list realtime
  async function startUsersListener(){
    if (unsubUsers) unsubUsers();
    const uCol = collection(db, 'users');
    unsubUsers = onSnapshot(uCol, snap => {
      usersList.innerHTML = '';
      snap.forEach(docSnap => {
        const d = docSnap.data(); const id = docSnap.id;
        if (currentUser && id === currentUser.uid) return; // skip self
        const node = userItemHtml(id, d);
        usersList.appendChild(node);
      });
    });
  }

  function userItemHtml(uid, data){
    const node = document.createElement('div');
    node.className = 'user-item';
    const avatar = document.createElement('div'); avatar.className='avatar';
    if (data.photoURL) { avatar.innerHTML = `<img src="${data.photoURL}" style="width:44px;height:44px;border-radius:50%"/>`; }
    else avatar.textContent = (data.username || data.displayName || 'U')[0]?.toUpperCase();
    const info = document.createElement('div'); info.style.flex='1';
    info.innerHTML = `<div style="font-weight:700">${escapeHtml(data.username || data.displayName || 'Unnamed')}</div><div class="small">${escapeHtml(data.email || '')}</div>`;
    node.appendChild(avatar); node.appendChild(info);
    node.onclick = () => { navTo('#/chat/'+uid); }
    return node;
  }

  // Search
  searchBox.addEventListener('input', () => {
    const q = searchBox.value.toLowerCase();
    const items = usersList.querySelectorAll('.user-item');
    items.forEach(it => {
      it.style.display = it.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  // Recent chats listener
  function startRecentListener(){
    if (unsubRecent) unsubRecent();
    const chatsCol = collection(db, 'chats');
    unsubRecent = onSnapshot(chatsCol, snap => {
      recentContainer.innerHTML = '';
      snap.forEach(docSnap => {
        const id = docSnap.id;
        if (!currentUser) return;
        if (!id.includes(currentUser.uid)) return;
        const parts = id.split('_'); const partner = parts[0]===currentUser.uid?parts[1]:parts[0];
        const node = document.createElement('div'); node.className='user-item';
        node.innerHTML = `<div class="avatar">${partner[0].toUpperCase()}</div><div style="flex:1"><div style="font-weight:700">${partner}</div><div class="small">${id}</div></div>`;
        node.onclick = () => navTo('#/chat/'+partner);
        recentContainer.appendChild(node);
      });
    });
  }

  // Open chat
  async function openChat(friendUid){
    if (!currentUser) { alert('Please login'); navTo('#/users'); return; }
    // set up chatId (lexicographic)
    const chatId = (currentUser.uid < friendUid) ? `${currentUser.uid}_${friendUid}` : `${friendUid}_${currentUser.uid}`;
    currentChatId = chatId;
    currentPeer = friendUid;
    chatTitle.textContent = 'Chat with ' + friendUid;
    chatSubtitle.textContent = 'chat id: ' + chatId;

    // unsubscribe old messages
    if (unsubMessages) unsubMessages();

    const messagesCol = collection(db, 'chats', chatId, 'messages');
    const q = query(messagesCol, orderBy('createdAt'));
    unsubMessages = onSnapshot(q, snapshot => {
      messagesEl.innerHTML = '';
      snapshot.forEach(ms => {
        const m = ms.data();
        const div = document.createElement('div');
        div.className = 'msg ' + (m.from === currentUser.uid ? 'me' : 'other');
        if (m.type === 'text') div.textContent = m.text;
        else if (m.type === 'image') {
          const img = document.createElement('img'); img.src = m.fileUrl; img.style.maxWidth='200px'; img.style.borderRadius='8px';
          div.appendChild(img);
        } else if (m.type === 'file') {
          const a = document.createElement('a'); a.href = m.fileUrl; a.textContent = m.fileName || 'File'; a.target='_blank';
          div.appendChild(a);
        }
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // load files list for conv info
    convFiles.innerHTML = '';
    const msgsSnap = await getDocs(messagesCol);
    msgsSnap.forEach(m=>{ const data = m.data(); if(data.type==='file'||data.type==='image'){ const a=document.createElement('a'); a.href=data.fileUrl; a.textContent=data.fileName||'file'; a.style.display='block'; convFiles.appendChild(a); }});
  }

  // Send message (text or file)
  sendMsgBtn.onclick = async () => {
    if (!currentChatId) return alert('Select user first');
    const text = messageInput.value.trim();
    const file = filePicker.files[0];
    const messagesCol = collection(db, 'chats', currentChatId, 'messages');
    if (!text && !file) return;
    const payload = { from: currentUser.uid, createdAt: serverTimestamp() };
    if (file) {
      // upload
      const path = `chatFiles/${currentChatId}/${Date.now()}_${file.name}`;
      const stRef = sref(storage, path);
      const snap = await uploadBytes(stRef, file);
      const url = await getDownloadURL(snap.ref);
      payload.type = file.type.startsWith('image/') ? 'image' : 'file';
      payload.fileUrl = url;
      payload.fileName = file.name;
    } else {
      payload.type = 'text';
      payload.text = text;
    }
    await addDoc(messagesCol, payload);
    messageInput.value = ''; filePicker.value = '';
  };

  // Profile page
  async function showProfile(){
    if (!currentUser) return navTo('#/users');
    const uRef = doc(db, 'users', currentUser.uid);
    const snap = await getDoc(uRef);
    const data = snap.exists() ? snap.data() : {};
    profileImg.src = data.photoURL || '';
    profileNameDisplay.textContent = data.displayName || currentUser.displayName || 'Unnamed';
    profileEmail.textContent = data.email || currentUser.email || '';
    usernameSet.value = data.username || '';
  }

  saveProfileBtn.onclick = async () => {
    if (!currentUser) return;
    const u = usernameSet.value.trim();
    // naive uniqueness: check users where username==u
    if (u) {
      const usersCol = collection(db, 'users');
      const q = query(usersCol, where('username','==',u));
      const res = await getDocs(q);
      if (!res.empty) {
        // if the only doc is mine then ok
        if (!(res.size === 1 && res.docs[0].id === currentUser.uid)) {
          return alert('Username already taken');
        }
      }
    }
    // if profile pic provided
    const file = profilePicInput.files[0];
    let photoURL = null;
    if (file) {
      const path = `profiles/${currentUser.uid}/${Date.now()}_${file.name}`;
      const stRef = sref(storage, path);
      const snap = await uploadBytes(stRef, file);
      photoURL = await getDownloadURL(snap.ref);
      profileImg.src = photoURL;
      topAvatar.innerHTML = `<img src="${photoURL}" style="width:40px;height:40px;border-radius:50%"/>`;
    }
    const uRef = doc(db, 'users', currentUser.uid);
    const updateObj = {};
    if (u) updateObj.username = u;
    if (photoURL) updateObj.photoURL = photoURL;
    await setDoc(uRef, updateObj, { merge: true });
    alert('Profile updated');
  };

  // Calls (basic WebRTC via Firestore signaling) - demo
  let pc=null, localStream=null, remoteStream=null, callDoc=null;
  async function startLocal(isVideo){
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:isVideo });
      localVid.srcObject = localStream;
    } catch(e){ alert('Mic/Camera permission denied: '+e.message); }
  }

  async function startCall(targetUid, isVideo){
    if (!currentUser) return alert('Login first');
    if (!targetUid) return alert('Enter target UID');
    await startLocal(isVideo);
    pc = new RTCPeerConnection();
    pc.ontrack = e => {
      if (!remoteStream) remoteStream = new MediaStream();
      remoteStream.addTrack(e.track);
      remoteVid.srcObject = remoteStream;
    };
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    // create call doc
    callDoc = await addDoc(collection(db,'calls'), { caller: currentUser.uid, callee: targetUid, createdAt: serverTimestamp() });
    const offerCandidates = collection(db,'calls',callDoc.id,'offerCandidates');
    const answerCandidates = collection(db,'calls',callDoc.id,'answerCandidates');

    pc.onicecandidate = e => { if (e.candidate) addDoc(offerCandidates, e.candidate.toJSON()); };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await setDoc(callDoc, { caller: currentUser.uid, callee: targetUid, offer: { type:offer.type, sdp:offer.sdp } }, { merge:true });

    // listen for answer
    onSnapshot(callDoc, snap => {
      const data = snap.data();
      if (!pc.currentRemoteDescription && data && data.answer) {
        pc.setRemoteDescription(data.answer);
      }
    });
    // listen for answerCandidates
    onSnapshot(answerCandidates, snap => {
      snap.docChanges().forEach(change => {
        if (change.type==='added') pc.addIceCandidate(change.doc.data());
      });
    });

    hangupBtn.classList.remove('hidden');
  }

  async function answerCall(callId, data){
    // callee accepts
    await startLocal(Boolean(data.offer && data.offer.sdp && data.offer.sdp.includes('m=video')));
    pc = new RTCPeerConnection();
    pc.ontrack = e => {
      if (!remoteStream) remoteStream = new MediaStream();
      remoteStream.addTrack(e.track);
      remoteVid.srcObject = remoteStream;
    };
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    const callRef = doc(db,'calls',callId);
    const offerCandidates = collection(db,'calls',callId,'offerCandidates');
    const answerCandidates = collection(db,'calls',callId,'answerCandidates');

    // add incomingICE
    onSnapshot(offerCandidates, snap => {
      snap.docChanges().forEach(ch => { if (ch.type==='added') pc.addIceCandidate(ch.doc.data()); });
    });

    pc.onicecandidate = e => { if (e.candidate) addDoc(answerCandidates, e.candidate.toJSON()); };

    await pc.setRemoteDescription(data.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await setDoc(callRef, { ...data, answer: { type:answer.type, sdp:answer.sdp }, answered:true }, { merge:true });

    hangupBtn.classList.remove('hidden');
  }

  // monitor incoming calls
  onSnapshot(collection(db,'calls'), snap => {
    incomingCalls.innerHTML = '';
    snap.forEach(docSnap => {
      const d = docSnap.data(); const id = docSnap.id;
      if (d.callee === (currentUser && currentUser.uid) && !d.answered) {
        const node = document.createElement('div'); node.className='user-item';
        node.innerHTML = `<div class="avatar">${(d.caller||'C')[0]}</div><div style="flex:1"><div style="font-weight:700">${d.caller}</div><div class="small">Incoming call</div></div>`;
        const accept = document.createElement('button'); accept.textContent='Accept';
        accept.onclick = () => answerCall(id,d);
        const reject = document.createElement('button'); reject.textContent='Reject';
        reject.style.marginLeft='6px';
        reject.onclick = () => { /* in production remove doc or set rejected flag */ };
        node.appendChild(accept); node.appendChild(reject);
        incomingCalls.appendChild(node);
      }
    });
  });

  hangupBtn.onclick = () => {
    if (pc) pc.close();
    if (localStream) { localStream.getTracks().forEach(t=>t.stop()); localVid.srcObject=null; }
    if (remoteStream) { remoteStream.getTracks().forEach(t=>t.stop()); remoteVid.srcObject=null; }
    hangupBtn.classList.add('hidden');
  };

  startVideoCallBtn.onclick = () => startCall(callTarget.value.trim(), true);
  startAudioCallBtn.onclick = () => startCall(callTarget.value.trim(), false);

  // UI helpers
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  // initial route
  window.onload = () => {
    if (!location.hash) location.hash = '#/users';
    handleRoute();
    // top logout mapping
    document.getElementById('signOutBtn').onclick = signOutBtn.onclick;
  };

  // simple show Users
  function showUsers(){ handleRoute(); }

  // nav helpers for chat open externally: allow friend UID or username
  async function openChat(target){
    // target may be uid or username. Try to find user by username first
    // If username-like (no @), try search
    let targetUid = target;
    // if target length not equal typical uid, try username lookup
    if (target && target.length < 30) {
      // try find user where username==target
      const usersCol = collection(db,'users');
      const q = query(usersCol, where('username','==',target));
      const res = await getDocs(q);
      if (!res.empty) { targetUid = res.docs[0].id; }
      else {
        // maybe target is uid as well, keep it
        targetUid = target;
      }
    }
    await openChat(targetUid);
  }

  </script>
</body>
</html>